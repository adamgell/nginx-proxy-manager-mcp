name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NPM_BASE_URL: http://localhost:8181/api
  TEST_EMAIL: test@example.com
  TEST_PASSWORD: test123456

jobs:
  test:
    name: ğŸ”¬ Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # We'll use docker-compose instead of GitHub services for better control
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npm run build

      - name: ğŸ³ Start NPM with Docker Compose
        run: |
          echo "ğŸš€ Starting NPM test environment..."
          docker-compose -f docker-compose.test.yml up -d
          
          echo "â³ Waiting for services to be healthy..."
          timeout 300 bash -c 'until docker-compose -f docker-compose.test.yml ps | grep -q "healthy"; do sleep 5; done'
          
          echo "ğŸ“Š Checking service status..."
          docker-compose -f docker-compose.test.yml ps
          
          echo "ğŸ” Checking NPM API health..."
          timeout 60 bash -c 'until curl -f http://localhost:8181/api/schema > /dev/null 2>&1; do sleep 2; done'

      - name: ğŸƒâ€â™‚ï¸ Run tests
        run: |
          echo "ğŸ§ª Running test suite..."
          npm test -- --coverage --verbose
        env:
          NODE_ENV: test

      - name: ğŸ“ˆ Upload coverage reports
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“‹ Display test results
        if: always()
        run: |
          echo "ğŸ“Š Test Summary"
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json | jq '.total'
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test environment..."
          docker-compose -f docker-compose.test.yml down -v
          docker system prune -f

  lint:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Build TypeScript
        run: npm run build

      - name: âœ… Check build artifacts
        run: |
          echo "ğŸ“ Build output:"
          ls -la dist/
          echo "ğŸ“„ Main entry point:"
          head -20 dist/index.js

  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ” Audit dependencies
        run: |
          npm audit --audit-level high
          npm audit --audit-level critical

      - name: ğŸ“‹ List dependencies
        run: |
          echo "ğŸ“Š Production dependencies:"
          npm ls --prod --depth=0
          echo ""
          echo "ğŸ›  Development dependencies:"
          npm ls --dev --depth=0

  docker-test:
    name: ğŸ³ Docker Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Test Docker Compose configuration
        run: |
          echo "ğŸ” Validating docker-compose.test.yml..."
          docker-compose -f docker-compose.test.yml config
          
          echo "ğŸš€ Testing service startup..."
          docker-compose -f docker-compose.test.yml up -d
          
          echo "â³ Waiting for services..."
          sleep 60
          
          echo "ğŸ“Š Service status:"
          docker-compose -f docker-compose.test.yml ps
          
          echo "ğŸ“‹ Service logs:"
          docker-compose -f docker-compose.test.yml logs --tail=50 npm
          
          echo "ğŸ§¹ Cleanup:"
          docker-compose -f docker-compose.test.yml down -v